<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="no-referrer-when-downgrade" />
  <title>Adaa CMS Admin</title>
  <base href="/admin/" />
</head>
<body>
  <script>
    (function() {
      console.log('[Decap OAuth] Initializing...');

      // Clear any stale OAuth messages from previous attempts
      try {
        const oldMessage = localStorage.getItem('decap_oauth_message');
        if (oldMessage) {
          console.log('[Decap OAuth] Clearing stale message from localStorage');
          localStorage.removeItem('decap_oauth_message');
        }
      } catch (e) {
        console.warn('[Decap OAuth] Could not clear localStorage:', e);
      }

      // Add debug listener to see if Decap CMS receives postMessage
      window.addEventListener('message', function(event) {
        // Check for object format (new approach)
        if (event.data && typeof event.data === 'object' && event.data.provider === 'github' && event.data.token) {
          console.log('[Decap OAuth] ✅ Received OAuth message from popup (object format)!');
          console.log('[Decap OAuth] Provider:', event.data.provider);
          console.log('[Decap OAuth] Token:', event.data.token.substring(0, 15) + '...');
          console.log('[Decap OAuth] Origin:', event.origin);
          console.log('[Decap OAuth] Source:', event.source ? 'popup window' : 'unknown');
        }
        // Check for string format (old approach - for debugging)
        else if (event.data && typeof event.data === 'string' && event.data.includes('authorization:github')) {
          console.log('[Decap OAuth] ⚠️ Received OAuth message in STRING format (should be object)');
          console.log('[Decap OAuth] Message:', event.data.substring(0, 150) + '...');
        }
      }, true); // Use capture phase to log before Decap CMS processes

      console.log('[Decap OAuth] Ready - waiting for OAuth messages');
    })();
  </script>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
</body>
</html>
